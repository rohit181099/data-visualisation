<html>
  <head>
    <style>
    	body {
			  margin: 0;
              font-family: "Helvetica Neue", sans-serif;
              			}

			#select, #legend {
				margin: 0 auto;
				display: table;
			}

			#select select {
				margin-right: 100px;
			}

			#legend {
				margin: 5px auto;
			}
			#legend text {
				font-size: .7em;
			}

			.subunit.district {
			  fill: #ddd;
			  stroke: #fff;
			  stroke-width: .5px;
			}
			.subunit.state {
				fill: none;
        stroke: #000;
        stroke-width: .2px;
			}
			.subunit-boundary {
			  fill: none;
			  stroke: #3a403d;
            }
            .d3-tip {

                background-color: #000;
                position: topright;
                padding: 2px 5px;
                border-radius: 10px;
                color: white;
                top: -30px;
                left: 60px;
                white-space: pre-line;
              }
          
    </style>
  </head>
  <body>
  
  <div id="select">
    <select id="column"></select>
    <select id="breaks"></select>
    <select id="count"></select>
    <select id="colors"></select>
    <button id="states" data="showing">Hide states</button>
</div>
<div id="legend"></div>
<div id="map"></div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.0/topojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel='stylesheet' type='text/css'>
<script>
    var xColumn = "longitude";
    var yColumn = "latitude";
    var rColumn = "population";
    var peoplePerPixel = 50000;
    
    var width = window.innerWidth,
         height = window.innerHeight ;

   
    var legendHeight = 22,
        legendBarHeight = 10,
        legendWidth = width / 2;

    var legend = d3.select("#legend").append("svg")
              .attr("width", legendWidth)
              .attr("height", legendHeight);

    var legendX = d3.scaleLinear()
			  .range([0, legendWidth]);

    var t = d3.transition()
              .duration(750);
              
    var columns = [{
            name: "Company Name",
            column: "sex_ratio"
        },
        {
            name: "RPM",
            column: "muslim_pct"
        },
        {
            name: "Battery Voltage",
            column: "houseless_per_lakh"
        }];   

        columns.forEach(function(d){
            $("#select #column").append("<option value='" + d.column + "'>" + d.name + "</option>")
        });
        var breaks = [
        {
            type: "Logarithmic",
            value: "l"
          }
          ];

          breaks.forEach(function(d){
            $("#select #breaks").append("<option value='" + d.value + "'>" + d.type + "</option>");
          });

          [3,4,5,6,7,8].forEach(function(d){
            $("#select #count").append("<option value='" + d + "'>" + d + "</option>");
          });
          $("#select #count").val(4);

          var colors = {
            "OrRd": {
			    3:["#fee8c8", "#fdbb84", "#e34a33"],
			    4:["#fef0d9", "#fdcc8a", "#fc8d59", "#d7301f"],
			    5:["#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000"],
			    6:["#fef0d9", "#fdd49e", "#fdbb84", "#fc8d59", "#e34a33", "#b30000"],
			    7:["#fef0d9", "#fdd49e", "#fdbb84", "#fc8d59", "#ef6548", "#d7301f", "#990000"],
			    8:["#fff7ec", "#fee8c8", "#fdd49e", "#fdbb84", "#fc8d59", "#ef6548", "#d7301f", "#990000"]
			  },
        };
        Object.keys(colors).forEach(function(d){
            $("#select #colors").append("<option value='" + d + "'>" + d + "</option>");
          });

          d3.queue()
         
          .defer(d3.csv, "data.csv")
         
          .await(ready);

  
          
    function ready( data) {

          var buckets = colorSubUnits(data, $("#select #breaks").val(), $("#select #count").val(), $("#select #colors").val(), $("#select #column").val());
          drawLegend(buckets, $("#select #colors").val());

          $("#select select").change(function(){
            buckets = colorSubUnits(data, $("#select #breaks").val(), $("#select #count").val(), $("#select #colors").val(), $("#select #column").val());
            drawLegend(buckets, $("#select #colors").val());
          });
        }

          function drawLegend(buckets, colorScheme){

            // update legendX domain
            legendX.domain([buckets[0].x, buckets[buckets.length - 1].x + buckets[buckets.length - 1].width]);

            // JOIN
            var legendRect = legend.selectAll(".legend-rect")
              .data(buckets, function(d){ return d.bucket; });

            var legendNumber = legend.selectAll(".legend-number")
              .data(buckets, function(d){ return d.bucket; });

            var legendMax = legend.selectAll(".legend-max")
              .data([buckets[buckets.length - 1].x + buckets[buckets.length - 1].width]);

            // EXIT
            legendRect.exit()
              .transition(t)
                .attr("opacity", 1e-6)
                .remove();

            legendNumber.exit()
              .transition(t)
                .attr("opacity", 1e-6)
                .remove();

            // UPDATE
            legendRect
              .transition(t)
                .attr("width", function(d){ return legendX(d.x + d.width); })
                .attr("x", function(d){ return legendX(d.x); })
                .attr("fill", function(d){ return d.color });
            
            legendNumber
              .transition(t)
                .attr("x", function(d){ return legendX(d.x); })
                .text(function(d){ return d.x.toFixed(2); });

            legendMax
                .attr("x", function(d){ return legendX(d); })
                .text(function(d){ return d.toFixed(2); })

            // ENTER
            legendRect.enter().append("rect")
                .attr("class", "legend-rect")
                .attr("y", 0)
                .attr("height", legendBarHeight)
                .attr("x", function(d){ return legendX(d.x); })
                .attr("fill", function(d){ return d.color })
                .attr("width", function(d){ return legendX(d.x + d.width); });

            legendNumber.enter().append("text")
                .attr("class", "legend-number")
                .attr("y", legendHeight)
                .attr("x", function(d){ return legendX(d.x); })
                .text(function(d){ return d.x.toFixed(2); });
                
            legendMax.enter().append("text")
                .attr("class", "legend-max")
                .attr("y", legendHeight)
                .attr("x", function(d){ return legendX(d); })
                .style("text-anchor", "end")
                .text(function(d){ return d.toFixed(2); });

          }

          function colorSubUnits(data, breakType, breakCount, colorScheme, value){
			  
            }
        </script>
        </body>
        </html>
            
